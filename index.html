<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#7b6cff" />
  <title>5秒アニメ（みんなで）ロビー</title>
  <link rel="stylesheet" href="./app.css" />
</head>
<body>

  <div class="wrap">
    <header>
      <div class="hL">
        <div class="hTitle">5秒アニメ（みんなで）</div>
        <div class="hSub" id="subLine">ロビー</div>
      </div>
      <div class="hR">
        
<div class="chip"><span class="dot off" id="netDot"></span><span id="netText">通信: 未確認</span></div>

      </div>
    </header>
    <main>

      <section class="card pad">
        <div class="box">
          <div class="mini">通信（サーバー）</div>
          <div class="row">
            <input id="wsBase" type="url" placeholder="https://サーバーURL" />
            <button id="saveWs" class="btn sub" style="flex:0 0 auto; min-width:110px;">保存</button>
          </div>
          <div class="row" style="margin-top:10px;">
            <button id="testBtn" class="btn ok">つながる？</button>
            <a class="btn sub" href="./gallery.html">自分の作品</a>
          </div>
        </div>

        <div class="box" style="margin-top:10px;">
          <div class="mini">はじめる</div>
          <div class="row">
            <a class="btn ok" href="./create.html">部屋を作る</a>
            <a class="btn ok" href="./random.html">だれかの続きを描く</a>
          </div>
          <div class="row" style="margin-top:10px;">
            <a class="btn sub" href="./private.html">合言葉で入る</a>
          </div>
        </div>
      </section>

  <div class="toast" id="toast"><div class="t" id="toastText">-</div></div>

  <script type="module">
    import { $, makeToast, getWsBase, setWsBase } from "./common.js";

    const say = makeToast();
    const netDot = $("netDot");
    const netText = $("netText");

    function setNet(ok, msg){
      netDot.classList.toggle("on", ok);
      netDot.classList.toggle("off", !ok);
      netText.textContent = ok ? (msg || "通信: OK") : (msg || "通信: NG");
    }

    $("wsBase").value = getWsBase();
    $("saveWs").addEventListener("click",()=>{
      setWsBase($("wsBase").value);
      say("保存");
    });

    $("testBtn").addEventListener("click", async ()=>{
      const base = $("wsBase").value.trim();
      if(!base){ say("サーバーURL"); setNet(false, "通信: URLなし"); return; }
      setWsBase(base);

      // /health を叩いて確認（CORSで失敗しても通信自体はできる可能性がある）
      let url = base.replace(/\/$/,"") + "/health";
      try{
        const res = await fetch(url, { cache:"no-store" });
        if(!res.ok) throw new Error("bad");
        const j = await res.json().catch(()=>({}));
        setNet(true, "通信: OK");
        say("OK");
      }catch(e){
        setNet(false, "通信: たぶんNG");
        say("NG（でもWSは通る時もある）", 2000);
      }
    });

    // 起動時
    setNet(false, "通信: 未確認");
  </script>

    </main>
  </div>
</body>
</html>
