<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#7b6cff" />
  <title>自分の作品</title>
  <link rel="stylesheet" href="./app.css" />
</head>
<body>

  <div class="wrap">
    <header>
      <div class="hL">
        <div class="hTitle">自分の作品</div>
        <div class="hSub">この端末の履歴</div>
      </div>
      <div class="hR">
<a class="btn sub" href="./index.html" style="width:auto; padding:10px 12px; font-size:14px;">ロビー</a>
</div>
    </header>
    <main>

      <section class="card pad">
        <div class="box">
          <div class="mini">一覧</div>
          <div class="list" id="list" style="margin-top:10px;"></div>
        </div>
      </section>
  <div class="toast" id="toast"><div class="t" id="toastText">-</div></div></main>
  </div>  <script src="./config.js"></script>
  <script src="./common.js"></script>
  <script>
(function(){
  const {$, makeToast, loadMyRooms, savePendingAction, getWsBase} = window.Anim5S;
  const say = makeToast();
  if(!getWsBase()) say("config.js のURLを入れて");

  const list = $("list");
  const rooms = loadMyRooms();

  function mkEmpty(){
    const d=document.createElement("div");
    d.className="item";
    d.innerHTML='<div><div class="id">まだない</div><div class="sub">描いた作品がここに出る</div></div>';
    list.appendChild(d);
  }

  async function copyText(txt){
    try{ await navigator.clipboard.writeText(txt); }
    catch{
      const t=document.createElement("textarea");
      t.value=txt; document.body.appendChild(t);
      t.select(); document.execCommand("copy"); t.remove();
    }
  }

  function addRoom(r){
    const it=document.createElement("div");
    it.className="item";

    const vis = (r.visibility==="private") ? "プライベート" : "公開";
    const sub = `${r.theme} / ${vis}`;

    it.innerHTML = `
      <div style="flex:1; min-width:0;">
        <div class="id" style="cursor:pointer;">ID ${r.roomId}</div>
        <div class="sub">${sub}</div>
      </div>
      <div class="row" style="flex:0 0 auto; gap:8px; width:auto;">
        <button class="btn sub" style="width:auto; min-width:140px; padding:10px 12px; font-size:14px;" type="button">現在の状態を閲覧</button>
        <button class="btn ok" style="width:auto; min-width:140px; padding:10px 12px; font-size:14px;" type="button">プライベートで編集</button>
      </div>
    `;

    const idLine = it.querySelector(".id");
    idLine.addEventListener("click", async ()=>{
      await copyText(r.roomId);
      say("コピー");
    });

    const buttons = it.querySelectorAll("button");
    const bView = buttons[0];
    const bFork = buttons[1];

    bView.addEventListener("click", ()=>{
      const a = { kind:"view", roomId:r.roomId, from:"gallery" };
      if(r.visibility==="private") a.passphrase = (r.pass||"");
      savePendingAction(a);
      location.href = "./editor.html";
    });

    bFork.addEventListener("click", ()=>{
      savePendingAction({ kind:"fork_prepare", srcRoomId:r.roomId, srcPassphrase: (r.visibility==="private" ? (r.pass||"") : "") });
      location.href = "./fork.html";
    });

    list.appendChild(it);
  }

  if(!rooms.length) mkEmpty();
  else rooms.forEach(addRoom);
})();
  </script>
</body>
</html>
